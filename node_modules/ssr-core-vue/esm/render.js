import { resolve } from 'path';
import { loadConfig, getCwd, StringToStream, mergeStream2 } from 'ssr-server-utils';
import { createRenderer } from 'vue-server-renderer';
const cwd = getCwd();
const defaultConfig = loadConfig();
const { renderToStream, renderToString } = createRenderer();
async function render(ctx, options) {
    var _a, _b, _c, _d;
    const config = Object.assign({}, defaultConfig, options !== null && options !== void 0 ? options : {});
    const { isDev, chunkName, stream } = config;
    const isLocal = isDev || process.env.NODE_ENV !== 'production';
    const serverFile = resolve(cwd, `./build/server/${chunkName}.server.js`);
    if (isLocal) {
        // clear cache in development environment
        delete require.cache[serverFile];
    }
    if (!ctx.response.type && typeof ctx.response.type !== 'function') {
        // midway/koa 场景设置默认 content-type
        ctx.response.type = 'text/html;charset=utf-8';
    }
    else if (!((_b = (_a = ctx.response).hasHeader) === null || _b === void 0 ? void 0 : _b.call(_a, 'content-type'))) {
        // express 场景
        (_d = (_c = ctx.response).setHeader) === null || _d === void 0 ? void 0 : _d.call(_c, 'Content-type', 'text/html;charset=utf-8');
    }
    const { serverRender } = require(serverFile);
    const serverRes = await serverRender(ctx, config);
    if (stream) {
        const stream = mergeStream2(new StringToStream('<!DOCTYPE html>'), renderToStream(serverRes));
        stream.on('error', (e) => {
            console.log(e);
        });
        return stream;
    }
    else {
        return `<!DOCTYPE html>${await renderToString(serverRes)}`;
    }
}
export { render };
