{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"@babel/runtime/regenerator\");\n\nvar _slicedToArray = require(\"@babel/runtime/helpers/slicedToArray\");\n\nvar _asyncToGenerator = require(\"@babel/runtime/helpers/asyncToGenerator\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.serverRender = void 0;\n\nvar Vue = require(\"vue\");\n\nvar ssr_server_utils_1 = require(\"ssr-server-utils\");\n\nvar vuex_router_sync_1 = require(\"vuex-router-sync\");\n\nvar serialize = require(\"serialize-javascript\"); // @ts-expect-error\n\n\nvar Routes = require(\"_build/ssr-temporary-routes\");\n\nvar create_1 = require(\"./create\");\n\nvar FeRoutes = Routes.FeRoutes,\n    App = Routes.App,\n    layoutFetch = Routes.layoutFetch,\n    Layout = Routes.Layout,\n    PrefixRouterBase = Routes.PrefixRouterBase;\n\nvar serverRender = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx, config) {\n    var _a, _b, cssOrder, jsOrder, dynamic, mode, customeHeadScript, customeFooterScript, chunkName, parallelFetch, disableClientRender, prefix, router, store, base, viteMode, _ctx$request, path, url, routeItem, dynamicCssOrder, manifest, isCsr, layoutFetchData, fetchData, fetch, currentFetch, _yield$Promise$all, _yield$Promise$all2, combineAysncData, state, app;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            cssOrder = config.cssOrder, jsOrder = config.jsOrder, dynamic = config.dynamic, mode = config.mode, customeHeadScript = config.customeHeadScript, customeFooterScript = config.customeFooterScript, chunkName = config.chunkName, parallelFetch = config.parallelFetch, disableClientRender = config.disableClientRender, prefix = config.prefix;\n            router = (0, create_1.createRouter)();\n            store = (0, create_1.createStore)();\n            base = prefix !== null && prefix !== void 0 ? prefix : PrefixRouterBase; // 以开发者实际传入的为最高优先级\n\n            viteMode = process.env.BUILD_TOOL === 'vite';\n            (0, vuex_router_sync_1.sync)(store, router);\n            _ctx$request = ctx.request, path = _ctx$request.path, url = _ctx$request.url;\n\n            if (base) {\n              path = (0, ssr_server_utils_1.normalizePath)(path, base);\n              url = (0, ssr_server_utils_1.normalizePath)(url, base);\n            }\n\n            routeItem = (0, ssr_server_utils_1.findRoute)(FeRoutes, path);\n\n            if (routeItem) {\n              _context.next = 11;\n              break;\n            }\n\n            throw new Error(\"\\n    \\u67E5\\u627E\\u7EC4\\u4EF6\\u5931\\u8D25\\uFF0C\\u8BF7\\u786E\\u8BA4\\u5F53\\u524D path: \".concat(path, \" \\u5BF9\\u5E94\\u524D\\u7AEF\\u7EC4\\u4EF6\\u662F\\u5426\\u5B58\\u5728\\n    \\u82E5\\u521B\\u5EFA\\u4E86\\u65B0\\u7684\\u9875\\u9762\\u6587\\u4EF6\\u5939\\uFF0C\\u8BF7\\u91CD\\u65B0\\u6267\\u884C npm start \\u91CD\\u542F\\u670D\\u52A1\\n    \"));\n\n          case 11:\n            dynamicCssOrder = cssOrder;\n\n            if (!(dynamic && !viteMode)) {\n              _context.next = 17;\n              break;\n            }\n\n            dynamicCssOrder = cssOrder.concat([\"\".concat(routeItem.webpackChunkName, \".css\")]);\n            _context.next = 16;\n            return (0, ssr_server_utils_1.addAsyncChunk)(dynamicCssOrder, routeItem.webpackChunkName);\n\n          case 16:\n            dynamicCssOrder = _context.sent;\n\n          case 17:\n            if (!viteMode) {\n              _context.next = 21;\n              break;\n            }\n\n            _context.t0 = {};\n            _context.next = 24;\n            break;\n\n          case 21:\n            _context.next = 23;\n            return (0, ssr_server_utils_1.getManifest)();\n\n          case 23:\n            _context.t0 = _context.sent;\n\n          case 24:\n            manifest = _context.t0;\n            isCsr = !!(mode === 'csr' || ((_a = ctx.request.query) === null || _a === void 0 ? void 0 : _a.csr));\n            layoutFetchData = {};\n            fetchData = {};\n\n            if (isCsr) {\n              _context.next = 66;\n              break;\n            }\n\n            fetch = routeItem.fetch;\n\n            if (!fetch) {\n              _context.next = 36;\n              break;\n            }\n\n            _context.next = 33;\n            return fetch();\n\n          case 33:\n            _context.t1 = _context.sent[\"default\"];\n            _context.next = 37;\n            break;\n\n          case 36:\n            _context.t1 = null;\n\n          case 37:\n            currentFetch = _context.t1;\n            router.push(url); // csr 下不需要服务端获取数据\n\n            if (!parallelFetch) {\n              _context.next = 48;\n              break;\n            }\n\n            _context.next = 42;\n            return Promise.all([layoutFetch ? layoutFetch({\n              store: store,\n              router: router.currentRoute\n            }, ctx) : Promise.resolve({}), currentFetch ? currentFetch({\n              store: store,\n              router: router.currentRoute\n            }, ctx) : Promise.resolve({})]);\n\n          case 42:\n            _yield$Promise$all = _context.sent;\n            _yield$Promise$all2 = _slicedToArray(_yield$Promise$all, 2);\n            layoutFetchData = _yield$Promise$all2[0];\n            fetchData = _yield$Promise$all2[1];\n            _context.next = 64;\n            break;\n\n          case 48:\n            if (!layoutFetch) {\n              _context.next = 54;\n              break;\n            }\n\n            _context.next = 51;\n            return layoutFetch({\n              store: store,\n              router: router.currentRoute\n            }, ctx);\n\n          case 51:\n            _context.t2 = _context.sent;\n            _context.next = 55;\n            break;\n\n          case 54:\n            _context.t2 = {};\n\n          case 55:\n            layoutFetchData = _context.t2;\n\n            if (!currentFetch) {\n              _context.next = 62;\n              break;\n            }\n\n            _context.next = 59;\n            return currentFetch({\n              store: store,\n              router: router.currentRoute\n            }, ctx);\n\n          case 59:\n            _context.t3 = _context.sent;\n            _context.next = 63;\n            break;\n\n          case 62:\n            _context.t3 = {};\n\n          case 63:\n            fetchData = _context.t3;\n\n          case 64:\n            _context.next = 67;\n            break;\n\n          case 66:\n            (0, ssr_server_utils_1.logGreen)(\"Current path \".concat(path, \" use csr render mode\"));\n\n          case 67:\n            combineAysncData = Object.assign({}, layoutFetchData !== null && layoutFetchData !== void 0 ? layoutFetchData : {}, fetchData !== null && fetchData !== void 0 ? fetchData : {});\n            state = Object.assign({}, (_b = store.state) !== null && _b !== void 0 ? _b : {}, combineAysncData); // @ts-expect-error\n\n            app = new Vue({\n              router: router,\n              store: store,\n              render: function render(h) {\n                var _a, _b;\n\n                var injectCss = [];\n\n                if (viteMode) {\n                  injectCss.push(h('link', {\n                    attrs: {\n                      rel: 'stylesheet',\n                      href: \"/server/static/css/\".concat(chunkName, \".css\")\n                    }\n                  }));\n                } else {\n                  dynamicCssOrder.forEach(function (css) {\n                    if (manifest[css]) {\n                      injectCss.push(h('link', {\n                        attrs: {\n                          rel: 'stylesheet',\n                          href: manifest[css]\n                        }\n                      }));\n                    }\n                  });\n                }\n\n                var injectScript = viteMode ? [h('script', {\n                  attrs: {\n                    type: 'module',\n                    src: '/node_modules/ssr-plugin-vue/esm/entry/client-entry.js'\n                  }\n                })] : jsOrder.map(function (js) {\n                  return h('script', {\n                    attrs: {\n                      src: manifest[js]\n                    }\n                  });\n                });\n                var viteClient = h('script', {\n                  attrs: {\n                    type: 'module',\n                    src: '/@vite/client'\n                  }\n                });\n                var customeHeadScriptArr = customeHeadScript ? (_a = Array.isArray(customeHeadScript) ? customeHeadScript : customeHeadScript(ctx)) === null || _a === void 0 ? void 0 : _a.map(function (item) {\n                  return h('script', Object.assign({}, item.describe, {\n                    domProps: {\n                      innerHTML: item.content\n                    }\n                  }));\n                }) : [];\n\n                if (disableClientRender) {\n                  customeHeadScriptArr.push(h('script', {\n                    domProps: {\n                      innerHTML: 'window.__disableClientRender__ = true'\n                    }\n                  }));\n                }\n\n                var customeFooterScriptArr = customeFooterScript ? (_b = Array.isArray(customeFooterScript) ? customeFooterScript : customeFooterScript(ctx)) === null || _b === void 0 ? void 0 : _b.map(function (item) {\n                  return h('script', Object.assign({}, item.describe, {\n                    domProps: {\n                      innerHTML: item.content\n                    }\n                  }));\n                }) : [];\n                return h(Layout, {\n                  props: {\n                    ctx: ctx,\n                    config: config,\n                    asyncData: combineAysncData,\n                    fetchData: layoutFetchData\n                  }\n                }, [h('template', {\n                  slot: 'remInitial'\n                }, [h('script', {}, [\"var w = document.documentElement.clientWidth / 3.75;document.getElementsByTagName('html')[0].style['font-size'] = w + 'px'\"])]), viteMode && h('template', {\n                  slot: 'viteClient'\n                }, [viteClient]), h('template', {\n                  slot: 'customeHeadScript'\n                }, customeHeadScriptArr), h('template', {\n                  slot: 'customeFooterScript'\n                }, customeFooterScriptArr), h('template', {\n                  slot: 'children'\n                }, [h(App, {\n                  props: {\n                    ctx: ctx,\n                    config: config,\n                    fetchData: combineAysncData\n                  }\n                })]), h('template', {\n                  slot: 'initialData'\n                }, [isCsr ? h('script', {\n                  domProps: {\n                    innerHTML: \"window.__USE_VITE__=\".concat(viteMode)\n                  }\n                }) : h('script', {\n                  domProps: {\n                    innerHTML: \"window.__USE_SSR__=true; window.__INITIAL_DATA__ =\".concat(serialize(state), \";window.__USE_VITE__=\").concat(viteMode)\n                  }\n                })]), h('template', {\n                  slot: 'cssInject'\n                }, injectCss), h('template', {\n                  slot: 'jsInject'\n                }, injectScript)]);\n              }\n            });\n            return _context.abrupt(\"return\", app);\n\n          case 71:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function serverRender(_x, _x2) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexports.serverRender = serverRender;","map":{"version":3,"sources":["/Users/yumengcheng/Study/nine-ssr/node_modules/ssr-plugin-vue/cjs/entry/server-entry.js"],"names":["Object","defineProperty","exports","value","serverRender","Vue","require","ssr_server_utils_1","vuex_router_sync_1","serialize","Routes","create_1","FeRoutes","App","layoutFetch","Layout","PrefixRouterBase","ctx","config","cssOrder","jsOrder","dynamic","mode","customeHeadScript","customeFooterScript","chunkName","parallelFetch","disableClientRender","prefix","router","createRouter","store","createStore","base","viteMode","process","env","BUILD_TOOL","sync","request","path","url","normalizePath","routeItem","findRoute","Error","dynamicCssOrder","concat","webpackChunkName","addAsyncChunk","getManifest","manifest","isCsr","_a","query","csr","layoutFetchData","fetchData","fetch","currentFetch","push","Promise","all","currentRoute","resolve","logGreen","combineAysncData","assign","state","_b","app","render","h","injectCss","attrs","rel","href","forEach","css","injectScript","type","src","map","js","viteClient","customeHeadScriptArr","Array","isArray","item","describe","domProps","innerHTML","content","customeFooterScriptArr","props","asyncData","slot"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.serverRender = void 0;\nconst Vue = require(\"vue\");\nconst ssr_server_utils_1 = require(\"ssr-server-utils\");\nconst vuex_router_sync_1 = require(\"vuex-router-sync\");\nconst serialize = require(\"serialize-javascript\");\n// @ts-expect-error\nconst Routes = require(\"_build/ssr-temporary-routes\");\nconst create_1 = require(\"./create\");\nconst { FeRoutes, App, layoutFetch, Layout, PrefixRouterBase } = Routes;\nconst serverRender = async (ctx, config) => {\n    var _a, _b;\n    const { cssOrder, jsOrder, dynamic, mode, customeHeadScript, customeFooterScript, chunkName, parallelFetch, disableClientRender, prefix } = config;\n    const router = (0, create_1.createRouter)();\n    const store = (0, create_1.createStore)();\n    const base = prefix !== null && prefix !== void 0 ? prefix : PrefixRouterBase; // 以开发者实际传入的为最高优先级\n    const viteMode = process.env.BUILD_TOOL === 'vite';\n    (0, vuex_router_sync_1.sync)(store, router);\n    let { path, url } = ctx.request;\n    if (base) {\n        path = (0, ssr_server_utils_1.normalizePath)(path, base);\n        url = (0, ssr_server_utils_1.normalizePath)(url, base);\n    }\n    const routeItem = (0, ssr_server_utils_1.findRoute)(FeRoutes, path);\n    if (!routeItem) {\n        throw new Error(`\n    查找组件失败，请确认当前 path: ${path} 对应前端组件是否存在\n    若创建了新的页面文件夹，请重新执行 npm start 重启服务\n    `);\n    }\n    let dynamicCssOrder = cssOrder;\n    if (dynamic && !viteMode) {\n        dynamicCssOrder = cssOrder.concat([`${routeItem.webpackChunkName}.css`]);\n        dynamicCssOrder = await (0, ssr_server_utils_1.addAsyncChunk)(dynamicCssOrder, routeItem.webpackChunkName);\n    }\n    const manifest = viteMode ? {} : await (0, ssr_server_utils_1.getManifest)();\n    const isCsr = !!(mode === 'csr' || ((_a = ctx.request.query) === null || _a === void 0 ? void 0 : _a.csr));\n    let layoutFetchData = {};\n    let fetchData = {};\n    if (!isCsr) {\n        const { fetch } = routeItem;\n        const currentFetch = fetch ? (await fetch()).default : null;\n        router.push(url);\n        // csr 下不需要服务端获取数据\n        if (parallelFetch) {\n            [layoutFetchData, fetchData] = await Promise.all([\n                layoutFetch ? layoutFetch({ store, router: router.currentRoute }, ctx) : Promise.resolve({}),\n                currentFetch ? currentFetch({ store, router: router.currentRoute }, ctx) : Promise.resolve({})\n            ]);\n        }\n        else {\n            layoutFetchData = layoutFetch ? await layoutFetch({ store, router: router.currentRoute }, ctx) : {};\n            fetchData = currentFetch ? await currentFetch({ store, router: router.currentRoute }, ctx) : {};\n        }\n    }\n    else {\n        (0, ssr_server_utils_1.logGreen)(`Current path ${path} use csr render mode`);\n    }\n    const combineAysncData = Object.assign({}, layoutFetchData !== null && layoutFetchData !== void 0 ? layoutFetchData : {}, fetchData !== null && fetchData !== void 0 ? fetchData : {});\n    const state = Object.assign({}, (_b = store.state) !== null && _b !== void 0 ? _b : {}, combineAysncData);\n    // @ts-expect-error\n    const app = new Vue({\n        router,\n        store,\n        render: function (h) {\n            var _a, _b;\n            const injectCss = [];\n            if (viteMode) {\n                injectCss.push(h('link', {\n                    attrs: {\n                        rel: 'stylesheet',\n                        href: `/server/static/css/${chunkName}.css`\n                    }\n                }));\n            }\n            else {\n                dynamicCssOrder.forEach(css => {\n                    if (manifest[css]) {\n                        injectCss.push(h('link', {\n                            attrs: {\n                                rel: 'stylesheet',\n                                href: manifest[css]\n                            }\n                        }));\n                    }\n                });\n            }\n            const injectScript = viteMode ? [h('script', {\n                    attrs: {\n                        type: 'module',\n                        src: '/node_modules/ssr-plugin-vue/esm/entry/client-entry.js'\n                    }\n                })] : jsOrder.map(js => h('script', {\n                attrs: {\n                    src: manifest[js]\n                }\n            }));\n            const viteClient = h('script', {\n                attrs: {\n                    type: 'module',\n                    src: '/@vite/client'\n                }\n            });\n            const customeHeadScriptArr = customeHeadScript ? (_a = (Array.isArray(customeHeadScript) ? customeHeadScript : customeHeadScript(ctx))) === null || _a === void 0 ? void 0 : _a.map(item => h('script', Object.assign({}, item.describe, {\n                domProps: {\n                    innerHTML: item.content\n                }\n            }))) : [];\n            if (disableClientRender) {\n                customeHeadScriptArr.push(h('script', {\n                    domProps: {\n                        innerHTML: 'window.__disableClientRender__ = true'\n                    }\n                }));\n            }\n            const customeFooterScriptArr = customeFooterScript ? (_b = (Array.isArray(customeFooterScript) ? customeFooterScript : customeFooterScript(ctx))) === null || _b === void 0 ? void 0 : _b.map(item => h('script', Object.assign({}, item.describe, {\n                domProps: {\n                    innerHTML: item.content\n                }\n            }))) : [];\n            return h(Layout, {\n                props: { ctx, config, asyncData: combineAysncData, fetchData: layoutFetchData }\n            }, [\n                h('template', {\n                    slot: 'remInitial'\n                }, [\n                    h('script', {}, [\n                        \"var w = document.documentElement.clientWidth / 3.75;document.getElementsByTagName('html')[0].style['font-size'] = w + 'px'\"\n                    ])\n                ]),\n                viteMode && h('template', {\n                    slot: 'viteClient'\n                }, [viteClient]),\n                h('template', {\n                    slot: 'customeHeadScript'\n                }, customeHeadScriptArr),\n                h('template', {\n                    slot: 'customeFooterScript'\n                }, customeFooterScriptArr),\n                h('template', {\n                    slot: 'children'\n                }, [\n                    h(App, {\n                        props: { ctx, config, fetchData: combineAysncData }\n                    })\n                ]),\n                h('template', {\n                    slot: 'initialData'\n                }, [\n                    isCsr ? h('script', {\n                        domProps: {\n                            innerHTML: `window.__USE_VITE__=${viteMode}`\n                        }\n                    }) : h('script', {\n                        domProps: {\n                            innerHTML: `window.__USE_SSR__=true; window.__INITIAL_DATA__ =${serialize(state)};window.__USE_VITE__=${viteMode}`\n                        }\n                    })\n                ]),\n                h('template', {\n                    slot: 'cssInject'\n                }, injectCss),\n                h('template', {\n                    slot: 'jsInject'\n                }, injectScript)\n            ]);\n        }\n    });\n    return app;\n};\nexports.serverRender = serverRender;\n"]},"metadata":{},"sourceType":"script"}