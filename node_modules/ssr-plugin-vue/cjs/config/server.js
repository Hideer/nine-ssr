"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getServerWebpack = void 0;
const path_1 = require("path");
const ssr_server_utils_1 = require("ssr-server-utils");
const webpack = require("webpack");
const base_1 = require("./base");
const loadModule = require.resolve;
const getServerWebpack = (chain) => {
    const config = (0, ssr_server_utils_1.loadConfig)();
    const { isDev, cwd, getOutput, chainServerConfig, whiteList, chunkName } = config;
    (0, base_1.getBaseConfig)(chain, true);
    chain.devtool(isDev ? 'inline-source-map' : false);
    chain.target('node');
    chain.entry(chunkName)
        .add(loadModule('../entry/server-entry'))
        .end()
        .output
        .path(getOutput().serverOutPut)
        .filename('[name].server.js')
        .libraryTarget('commonjs')
        .end();
    const modulesDir = [(0, path_1.join)(cwd, './node_modules')];
    modulesDir.push((0, ssr_server_utils_1.getLocalNodeModules)());
    chain.externals((0, ssr_server_utils_1.nodeExternals)({
        whitelist: [/\.(css|less|sass|scss)/, /vant.*?style/, /antd.*?(style)/, /ant-design-vue.*?(style)/].concat(whiteList || [], /store$/),
        // externals Dir contains example/xxx/node_modules ssr/node_modules
        modulesDir
    }));
    chain.when(isDev, () => {
        chain.watch(true);
    });
    chain.plugin('serverLimit').use(webpack.optimize.LimitChunkCountPlugin, [{
            maxChunks: 1
        }]);
    chainServerConfig(chain); // 合并用户自定义配置
    return chain.toConfig();
};
exports.getServerWebpack = getServerWebpack;
