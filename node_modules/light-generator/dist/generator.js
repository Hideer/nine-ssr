"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LightGenerator = void 0;
const copyDirContents_1 = require("./util/copyDirContents");
const NpmPatternGenerator_1 = require("./generator/NpmPatternGenerator");
const LocalPatternGenerator_1 = require("./generator/LocalPatternGenerator");
const rule_1 = require("./rule");
const util_1 = require("./util/");
const fs_1 = require("./util/fs");
const fs_extra_1 = require("fs-extra");
const events_1 = __importDefault(require("events"));
class LightGenerator {
    constructor(options = { disableDefaultRule: false }) {
        this.options = options;
        this.eventCenter = new events_1.default();
        this.copyWalker = new copyDirContents_1.DirectoryCopyWalker(Object.assign(this.options, {
            eventCenter: this.eventCenter,
        }));
        if (!this.options.disableDefaultRule) {
            this.addDefaultCopyRule();
        }
    }
    addDefaultCopyRule() {
        this.copyWalker.addCopyRule(rule_1.replaceRule);
        this.copyWalker.addCopyRule(rule_1.ignoreRule);
    }
    defineLocalPath(options) {
        return new LocalPatternGenerator_1.LocalPatternGenerator({
            templateUri: options.templatePath,
            targetPath: options.targetPath,
            templateName: options.templateName,
            copyWalker: this.copyWalker,
            eventCenter: this.eventCenter,
        });
    }
    defineNpmPackage(options) {
        let npmClient = options.npmClient || 'npm';
        // 内部执行的命令，yarn 没有，所以固化为 npm
        if (npmClient === 'yarn') {
            npmClient = 'npm';
        }
        // 默认安装，可选择跳过
        const npmInstall = typeof options.npmInstall === 'boolean' ? options.npmInstall : true;
        return new NpmPatternGenerator_1.NpmPatternGenerator({
            templateUri: options.npmPackage,
            targetPath: options.targetPath,
            copyWalker: this.copyWalker,
            npmClient,
            registryUrl: options.registryUrl,
            eventCenter: this.eventCenter,
            npmInstall,
            targetVersion: options.targetVersion || 'latest',
        });
    }
    static async cleanCache() {
        const tmpDir = util_1.getTmpDir();
        if (fs_1.dirExistsSync(tmpDir)) {
            await fs_extra_1.remove(tmpDir);
        }
    }
}
exports.LightGenerator = LightGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSw0REFBNkQ7QUFFN0QseUVBQXNFO0FBQ3RFLDZFQUEwRTtBQUMxRSxpQ0FBaUQ7QUFDakQsa0NBQW9DO0FBQ3BDLGtDQUEwQztBQUMxQyx1Q0FBa0M7QUFDbEMsb0RBQWtDO0FBRWxDLE1BQWEsY0FBYztJQUt6QixZQUNFLFVBR0ksRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUU7UUFFakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGdCQUFZLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUkscUNBQW1CLENBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUMxQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7U0FDOUIsQ0FBQyxDQUNILENBQUM7UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRTtZQUNwQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsa0JBQVcsQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLGlCQUFVLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsZUFBZSxDQUFDLE9BSWY7UUFDQyxPQUFPLElBQUksNkNBQXFCLENBQUM7WUFDL0IsV0FBVyxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2pDLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVTtZQUM5QixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQzNCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztTQUM5QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsT0FRaEI7UUFDQyxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQztRQUMzQyw0QkFBNEI7UUFDNUIsSUFBSSxTQUFTLEtBQUssTUFBTSxFQUFFO1lBQ3hCLFNBQVMsR0FBRyxLQUFLLENBQUM7U0FDbkI7UUFDRCxhQUFhO1FBQ2IsTUFBTSxVQUFVLEdBQUcsT0FBTyxPQUFPLENBQUMsVUFBVSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ3ZGLE9BQU8sSUFBSSx5Q0FBbUIsQ0FBQztZQUM3QixXQUFXLEVBQUUsT0FBTyxDQUFDLFVBQVU7WUFDL0IsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVO1lBQzlCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUMzQixTQUFTO1lBQ1QsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1lBQ2hDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixVQUFVO1lBQ1YsYUFBYSxFQUFFLE9BQU8sQ0FBQyxhQUFhLElBQUksUUFBUTtTQUNqRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVO1FBQ3JCLE1BQU0sTUFBTSxHQUFHLGdCQUFTLEVBQUUsQ0FBQztRQUMzQixJQUFJLGtCQUFhLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDekIsTUFBTSxpQkFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztDQUNGO0FBNUVELHdDQTRFQyJ9